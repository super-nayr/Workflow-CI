name: Train Model CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  train:
    runs-on: ubuntu-latest

    env:
      DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_USER_TOKEN }}

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        environment-file: MLProject/conda.yaml
        activate-environment: base
        auto-activate-base: true

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Jalankan Training dan Tangkap Run ID
      run: |
        TRAINING_OUTPUT=$(python MLProject/modelling.py --data_path MLProject/survey_lung_cancer_clean.csv 2>&1)

        echo "--- Captured Python Script Output ---"
        echo "$TRAINING_OUTPUT"
        echo "--- End Captured Output ---"

        LATEST_RUN_ID=$(echo "$TRAINING_OUTPUT" | grep "MLflow Run ID:" | cut -d' ' -f4)

        if [ -z "$LATEST_RUN_ID" ]; then
          echo "::error::Tidak dapat menemukan 'MLflow Run ID:' dari log. Skrip Python dipastikan GAGAL."
          exit 1
        fi

        echo "Run ID yang berhasil ditangkap: ${LATEST_RUN_ID}"
        echo "run_id=${LATEST_RUN_ID}" >> $GITHUB_OUTPUT

name: Final CI - Train, Build, and Push

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  train-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: '3.9'
          environment-file: MLProject/conda.yaml 
          activate-environment: lung-cancer-env
          auto-activate-base: false
      
      - name: Run Python Training Script and Capture Run ID
        id: training_step
        shell: bash -l {0}
        run: |
          # Menjalankan skrip Python secara langsung dengan parameter
          TRAINING_OUTPUT=$(python MLProject/modelling.py --data_path MLProject/survey_lung_cancer_clean.csv --C 1.0 --max_iter 1000 2>&1)
          
          echo "--- Captured Python Script Output ---"
          echo "$TRAINING_OUTPUT"
          echo "--- End Captured Output ---"
          
          # Ekstrak Run ID dari log yang kita cetak secara eksplisit
          LATEST_RUN_ID=$(echo "$TRAINING_OUTPUT" | grep "MLflow Run ID:" | cut -d' ' -f4)
          
          if [ -z "$LATEST_RUN_ID" ]; then
            echo "::error::Tidak dapat menemukan 'MLflow Run ID:' dari log training. Skrip Python dipastikan GAGAL."
            exit 1
          fi
          echo "Run ID yang berhasil ditangkap: ${LATEST_RUN_ID}"
          echo "run_id=${LATEST_RUN_ID}" >> $GITHUB_OUTPUT
        env:
          DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        shell: bash -l {0}
        run: |
          RUN_ID="${{ steps.training_step.outputs.run_id }}"
          if [ -z "$RUN_ID" ]; then
            echo "::error::Tidak dapat menemukan Run ID dari langkah sebelumnya."
            exit 1
          fi
          echo "Run ID yang akan digunakan: $RUN_ID"
          
          mlflow artifacts download --run-id "${RUN_ID}" --artifact-path "model_files" --dst-path .
          
          echo "Artifak berhasil diunduh. Membangun Docker image..."
          
          mlflow models build-docker --model-uri "./model_files" --name "${{ secrets.DOCKERHUB_USERNAME }}/lung-cancer-predictor:latest" --enable-mlserver
            
          docker push "${{ secrets.DOCKERHUB_USERNAME }}/lung-cancer-predictor:latest"
        env:
          DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}